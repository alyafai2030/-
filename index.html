<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>رماية التوقيت</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Tajawal', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    .page {
      display: none;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        align-items: center;
        justify-content: center;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-200">
  <header class="bg-slate-800 shadow-lg">
    <nav class="container mx-auto flex justify-between items-center p-3">
      <h1 class="text-2xl font-bold text-sky-200">رماية التوقيت</h1>
      <div class="flex gap-2">
        <a id="nav-entry" href="#entry" class="px-3 py-2 rounded-md text-sm font-small transition-colors">
          تسجيل النتائج
        </a>
        <a id="nav-results" href="#results" class="px-3 py-2 rounded-md text-sm font-small transition-colors">
          النتائج المحفوظة
        </a>
      </div>
    </nav>
  </header>
  
  <main class="container mx-auto p-4 md:p-6">
    <!-- Score Entry Page -->
    <div id="page-entry" class="page">
      <div class="max-w-4xl mx-auto bg-slate-800 p-4 md:p-6 rounded-lg shadow-xl">
        <h2 id="entry-title" class="text-2xl md:text-3xl font-bold mb-6 text-center text-sky-400">
          تسجيل نتائج الرماية
        </h2>
        
        <div class="mb-4">
          <label for="shooterNameSelect" class="block text-base md:text-lg font-medium text-slate-300 mb-2">اسم الرامي</label>
          <div class="flex gap-2">
            <select id="shooterNameSelect" class="w-full bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
              <!-- Options will be populated by JS -->
            </select>
            <button id="manage-shooters-button" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition-colors whitespace-nowrap">
              إدارة
            </button>
          </div>
        </div>

        <div class="hidden md:grid grid-cols-12 gap-2 text-center mb-2 font-bold text-slate-400 text-sm">
          <div class="col-span-2">المرحلة</div>
          <div class="col-span-3">الوقت (ث)</div>
          <div class="col-span-4">الإصابة</div>
          <div class="col-span-3">النقاط</div>
        </div>

        <div id="stages-container" class="space-y-2">
          <!-- Stages will be dynamically inserted here -->
        </div>

        <div class="mt-8 text-center bg-slate-900/70 p-4 rounded-lg">
          <h3 class="text-2xl font-bold text-slate-300">النتيجة الإجمالية</h3>
          <p class="text-5xl font-bold text-sky-400 mt-2"><span id="total-score">0</span> <span class="text-5xl text-slate-400">/ 50</span></p>
        </div>

        <div class="mt-8 flex justify-center gap-4">
          <button id="save-button" class="bg-sky-600 hover:bg-sky-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition-colors">
            حفظ النتيجة
          </button>
          <button id="reset-button" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-2 rounded-lg transition-colors">
            مسح
          </button>
        </div>
      </div>
    </div>

    <!-- Results Page -->
    <div id="page-results" class="page">
      <div class="max-w-7xl mx-auto bg-slate-800 p-4 md:p-6 rounded-lg shadow-xl">
        <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-sky-400">النتائج المحفوظة</h2>
          <div id="results-actions" class="flex flex-wrap gap-2" style="display: none;">
             <button id="export-csv-button" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
              تصدير CSV
            </button>
            <button id="clear-all-button" class="flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
              <span role="img" aria-hidden="true">🗑️</span>
              مسح الكل
            </button>
          </div>
        </div>
        
        <div id="results-content">
            <!-- Results will be dynamically inserted here -->
        </div>

      </div>
    </div>
  </main>
  
  <!-- Shooters Management Modal -->
  <div id="shooters-modal" class="modal">
    <div class="bg-slate-800 rounded-lg shadow-xl p-4 md:p-6 w-11/12 max-w-md m-4">
        <h3 class="text-xl md:text-2xl font-bold text-sky-400 mb-4 text-center">إدارة الرماة</h3>
        
        <div class="flex gap-2 mb-4">
            <input type="text" id="new-shooter-name-input" placeholder="اسم الرامي الجديد" class="flex-grow bg-slate-700 border border-slate-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
            <button id="add-shooter-button" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-3 rounded-lg transition-colors">إضافة</button>
        </div>

        <div class="mb-4">
            <button id="import-shooters-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">استيراد قائمة من ملف (.txt)</button>
            <input type="file" id="shooters-file-input" accept=".txt" class="hidden">
            <p class="text-xs text-slate-400 mt-1 text-center">يجب أن يحتوي الملف على اسم واحد في كل سطر.</p>
        </div>

        <h4 class="text-base md:text-lg font-semibold text-slate-300 mb-2 border-t border-slate-700 pt-3">قائمة الرماة</h4>
        <div id="shooters-list-container" class="max-h-60 overflow-y-auto no-scrollbar bg-slate-900 p-2 rounded-md space-y-2">
            <!-- Shooters list will be rendered here -->
        </div>
        
        <div class="mt-6 text-center">
            <button id="close-modal-button" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">إغلاق</button>
        </div>
    </div>
  </div>
  
<script type="module">
  const SCORES_STORAGE_KEY = 'tas-timer-scores';
  const SHOOTERS_STORAGE_KEY = 'tas-shooters-list';
  
  // --- STATE MANAGEMENT ---
  let allScores = [];
  let shootersList = [];
  let currentEditId = null;
  let currentShooterName = '';
  let currentStages = Array(5).fill({ time: '', hit: true });
  let currentSortBy = 'date';

  // --- DOM ELEMENTS ---
  const shooterNameSelect = document.getElementById('shooterNameSelect');
  const stagesContainer = document.getElementById('stages-container');
  const totalScoreEl = document.getElementById('total-score');
  const saveButton = document.getElementById('save-button');
  const resetButton = document.getElementById('reset-button');
  const entryTitle = document.getElementById('entry-title');
  const resultsContent = document.getElementById('results-content');
  const resultsActions = document.getElementById('results-actions');
  const shootersModal = document.getElementById('shooters-modal');
  const newShooterNameInput = document.getElementById('new-shooter-name-input');
  const shootersListContainer = document.getElementById('shooters-list-container');
  const shootersFileInput = document.getElementById('shooters-file-input');


  // --- SCORE CALCULATION LOGIC ---
  const calculateStageScore = (stageIndex, timeStr, hit) => {
    if (!hit || timeStr === '' || isNaN(parseFloat(timeStr))) return 0;
    const time = parseFloat(timeStr);
    const timeInHundredths = Math.round(time * 100);

    if (stageIndex === 0 || stageIndex === 2 || stageIndex === 4) {
      if (timeInHundredths <= 304) return 10;
      const penalty = Math.ceil((timeInHundredths - 304) / 5);
      return Math.max(0, 10 - penalty);
    }
    if (stageIndex === 1 || stageIndex === 3) {
      if (timeInHundredths <= 509) return 10;
      const penalty = Math.ceil((timeInHundredths - 509) / 10);
      return Math.max(0, 10 - penalty);
    }
    return 0;
  };

  // --- RENDER FUNCTIONS ---
  function renderEntryForm(focusedInputIndex = null) {
    stagesContainer.innerHTML = '';
    let totalScore = 0;
    
    populateShooterDropdown();

    currentStages.forEach((stage, index) => {
      const stageScore = calculateStageScore(index, stage.time, stage.hit);
      totalScore += stageScore;
      
      const scoreColorClass = stageScore === 10 ? 'bg-green-500 text-white' : stageScore > 0 ? 'bg-amber-500 text-slate-900' : 'bg-red-600 text-white';

      const stageEl = document.createElement('div');
      stageEl.className = 'grid grid-cols-12 gap-2 items-center bg-slate-700/50 p-2 rounded-md';
      stageEl.innerHTML = `
        <div class="col-span-2 text-center font-bold text-sm sm:text-base">
          <span class="md:hidden">م${index + 1}</span>
          <span class="hidden md:inline">المرحلة ${index + 1}</span>
        </div>
        <div class="col-span-3">
          <input
            type="text"
            inputMode="decimal"
            value="${stage.time}"
            placeholder="0.00"
            class="stage-time-input w-full bg-slate-900 border border-slate-600 rounded-md py-2 px-2 text-center text-white focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm sm:text-base"
            data-index="${index}"
          />
        </div>
        <div class="col-span-4 grid grid-cols-2 gap-1">
          <button class="hit-button py-2 px-1 rounded-md transition-all text-sm ${stage.hit ? 'bg-green-600 text-white ring-2 ring-white' : 'bg-slate-600 hover:bg-green-700'}" data-index="${index}" data-hit="true" aria-label="إصابة">
            <span role="img" aria-hidden="true">✔️</span>
            <span class="hidden sm:inline"> إصابة</span>
          </button>
          <button class="hit-button py-2 px-1 rounded-md transition-all text-sm ${!stage.hit ? 'bg-red-600 text-white ring-2 ring-white' : 'bg-slate-600 hover:bg-red-700'}" data-index="${index}" data-hit="false" aria-label="عدم إصابة">
            <span role="img" aria-hidden="true">❌</span>
            <span class="hidden sm:inline"> خطأ</span>
          </button>
        </div>
        <div class="col-span-3 flex justify-center">
          <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold ${scoreColorClass} shadow-lg">
            ${stageScore}
          </div>
        </div>
      `;
      stagesContainer.appendChild(stageEl);
    });
    
    totalScoreEl.textContent = totalScore;
    updateSaveButtonState();

    if (focusedInputIndex !== null) {
      const inputToFocus = stagesContainer.querySelector(`.stage-time-input[data-index="${focusedInputIndex}"]`);
      if (inputToFocus) {
        inputToFocus.focus();
        const len = inputToFocus.value.length;
        inputToFocus.setSelectionRange(len, len);
      }
    }
  }
  
  function renderResults() {
    if (allScores.length === 0) {
      resultsContent.innerHTML = `<p class="text-center text-slate-400 text-lg">لا توجد نتائج محفوظة حتى الآن.</p>`;
      resultsActions.style.display = 'none';
      return;
    }

    resultsActions.style.display = 'flex';
    const sortedScores = [...allScores].sort((a, b) => {
      if (currentSortBy === 'score') return b.totalScore - a.totalScore;
      return new Date(b.date).getTime() - new Date(a.date).getTime();
    });

    const formatDate = (dateString) => new Date(dateString).toLocaleString('ar-EG', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit',
    });

    const mobileHTML = sortedScores.map(score => `
      <div class="bg-slate-700/50 p-3 rounded-lg shadow-md">
        <div class="flex justify-between items-center gap-2">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-white truncate">${score.name}</p>
            <p class="text-[11px] text-slate-400 truncate">${formatDate(score.date)}</p>
          </div>
          <div class="text-center">
            <p class="text-xl font-bold text-sky-400">${score.totalScore}</p>
          </div>
          <div class="flex items-center gap-1">
            <a href="#edit/${score.id}" class="bg-blue-600 hover:bg-blue-500 text-white p-1.5 rounded-full h-8 w-8 flex items-center justify-center" aria-label="تعديل نتيجة ${score.name}">
              <span role="img" aria-hidden="true" class="text-base">✏️</span>
            </a>
            <button data-id="${score.id}" data-name="${score.name}" class="delete-button bg-red-700 hover:bg-red-600 text-white p-1.5 rounded-full h-8 w-8 flex items-center justify-center" aria-label="حذف نتيجة ${score.name}">
              <span role="img" aria-hidden="true" class="text-base">🗑️</span>
            </button>
          </div>
        </div>
        <div class="mt-3 pt-3 border-t border-slate-600">
          <div class="grid grid-cols-5 gap-1">
            ${score.stages.map((stage, index) => {
              const stageScore = calculateStageScore(index, stage.time, stage.hit);
              return `
                <div class="text-center bg-slate-800 p-1 rounded-md flex flex-col justify-center">
                  <p class="text-xs font-bold text-slate-400 truncate">م ${index + 1}</p>
                  <p class="text-sm font-bold text-sky-400">${stageScore} <span class="text-[10px] text-slate-400">ن</span></p>
                  <p class="text-[11px] font-semibold text-white">${stage.time} ث</p>
                </div>`;
            }).join('')}
          </div>
        </div>
      </div>
    `).join('');

    const desktopHTML = `
      <table class="w-full text-sm text-left text-slate-400">
        <thead class="text-xs text-slate-300 uppercase bg-slate-700/50">
          <tr>
            <th scope="col" class="px-4 py-3">الرامي</th>
            <th scope="col" class="px-4 py-3">التاريخ</th>
            ${[...Array(5)].map((_, i) => `<th scope="col" class="px-2 py-3 text-center">المرحلة ${i + 1}</th>`).join('')}
            <th scope="col" class="px-3 py-3 text-center">الإجمالي</th>
            <th scope="col" class="px-4 py-3 text-center">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          ${sortedScores.map(score => `
            <tr class="bg-slate-800 border-b border-slate-700 hover:bg-slate-700/50 transition-colors">
              <td class="px-4 py-3 font-medium text-white whitespace-nowrap">${score.name}</td>
              <td class="px-4 py-3 text-xs">${formatDate(score.date)}</td>
              ${score.stages.map((stage, index) => {
                const stageScore = calculateStageScore(index, stage.time, stage.hit);
                return `
                  <td class="px-2 py-3 text-center">
                    <div class="font-bold text-sky-400">${stageScore} ن</div>
                    <div class="text-xs text-slate-300">${stage.time} ث</div>
                  </td>`;
              }).join('')}
              <td class="px-3 py-3 text-center font-bold text-lg text-sky-400">${score.totalScore}</td>
              <td class="px-4 py-3 text-center">
                <div class="flex justify-center items-center gap-2">
                  <a href="#edit/${score.id}" class="p-2 rounded-full hover:bg-blue-500/50" aria-label="تعديل نتيجة ${score.name}">
                    <span role="img" aria-hidden="true" class="text-xl">✏️</span>
                  </a>
                  <button data-id="${score.id}" data-name="${score.name}" class="delete-button p-2 rounded-full hover:bg-red-500/50" aria-label="حذف نتيجة ${score.name}">
                    <span role="img" aria-hidden="true" class="text-xl">🗑️</span>
                  </button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    resultsContent.innerHTML = `
        <div class="flex justify-end gap-4 mb-4">
            <span class="self-center text-slate-300">ترتيب حسب:</span>
            <button id="sort-date-button" class="px-4 py-2 rounded-md text-sm font-medium transition-colors ${currentSortBy === 'date' ? 'bg-sky-600 text-white' : 'bg-slate-700 hover:bg-slate-600'}">
              الأحدث
            </button>
            <button id="sort-score-button" class="px-4 py-2 rounded-md text-sm font-medium transition-colors ${currentSortBy === 'score' ? 'bg-sky-600 text-white' : 'bg-slate-700 hover:bg-slate-600'}">
              الأعلى نقاطاً
            </button>
        </div>
        <div class="space-y-3 md:hidden">${mobileHTML}</div>
        <div class="hidden md:block overflow-x-auto">${desktopHTML}</div>
    `;

    document.getElementById('sort-date-button').addEventListener('click', () => handleSort('date'));
    document.getElementById('sort-score-button').addEventListener('click', () => handleSort('score'));
    document.querySelectorAll('.delete-button').forEach(btn => btn.addEventListener('click', handleDeleteClick));
  }

  // --- SHOOTER MANAGEMENT ---
  function renderShootersListInModal() {
    shootersListContainer.innerHTML = '';
    if (shootersList.length === 0) {
        shootersListContainer.innerHTML = `<p class="text-center text-slate-400 p-4">لا يوجد رماة محفوظون.</p>`;
        return;
    }
    shootersList.forEach(name => {
        const shooterEl = document.createElement('div');
        shooterEl.className = 'flex justify-between items-center bg-slate-800 p-2 rounded';
        shooterEl.innerHTML = `
            <span class="text-white">${name}</span>
            <button data-name="${name}" class="delete-shooter-button text-red-400 hover:text-red-300" aria-label="حذف ${name}">
                <span role="img" aria-hidden="true">🗑️</span>
            </button>
        `;
        shootersListContainer.appendChild(shooterEl);
    });
    document.querySelectorAll('.delete-shooter-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const nameToDelete = e.currentTarget.dataset.name;
            handleDeleteShooter(nameToDelete);
        });
    });
  }

  function handleAddShooter() {
    const name = newShooterNameInput.value.trim();
    if (name && !shootersList.includes(name)) {
        shootersList.push(name);
        shootersList.sort((a, b) => a.localeCompare(b, 'ar'));
        saveShootersToLocalStorage();
        renderShootersListInModal();
        populateShooterDropdown();
        newShooterNameInput.value = '';
    } else if (shootersList.includes(name)) {
        alert('هذا الاسم موجود بالفعل.');
    }
  }

  function handleDeleteShooter(nameToDelete) {
    if (confirm(`هل أنت متأكد من حذف الرامي "${nameToDelete}"؟`)) {
        shootersList = shootersList.filter(name => name !== nameToDelete);
        saveShootersToLocalStorage();
        renderShootersListInModal();
        populateShooterDropdown();
    }
  }

  function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const content = e.target.result;
        const names = content.split('\n')
            .map(name => name.trim())
            .filter(name => name.length > 0);
        
        const newNames = names.filter(name => !shootersList.includes(name));
        if (newNames.length > 0) {
            shootersList = [...shootersList, ...newNames];
            shootersList.sort((a, b) => a.localeCompare(b, 'ar'));
            saveShootersToLocalStorage();
            renderShootersListInModal();
            populateShooterDropdown();
            alert(`تم استيراد ${newNames.length} اسم جديد بنجاح.`);
        } else {
            alert('لم يتم العثور على أسماء جديدة في الملف.');
        }
        shootersFileInput.value = ''; // Reset file input
    };
    reader.readAsText(file);
  }

  // --- EVENT HANDLERS ---
  function handleTimeInputChange(e) {
    const index = parseInt(e.target.dataset.index, 10);
    let value = e.target.value;
    let digits = value.replace(/[^0-9]/g, '');

    if (digits.length > 3) {
      digits = digits.substring(0, 3);
    }

    let formattedValue = digits;
    if (digits.length >= 2) {
      formattedValue = digits.slice(0, 1) + '.' + digits.slice(1);
    }

    const newStages = [...currentStages];
    newStages[index] = { ...newStages[index], time: formattedValue };
    currentStages = newStages;
    
    renderEntryForm(index);
  }

  function handleHitButtonClick(e) {
    const button = e.target.closest('.hit-button');
    const index = parseInt(button.dataset.index, 10);
    const hit = button.dataset.hit === 'true';
    const newStages = [...currentStages];
    newStages[index] = { ...newStages[index], hit: hit };
    currentStages = newStages;
    renderEntryForm();
  }
  
  function handleNameChange(e) {
    currentShooterName = e.target.value;
    updateSaveButtonState();
  }

  function handleSave() {
    if (!isFormValid()) return;
    const totalScore = currentStages.reduce((sum, stage, index) => sum + calculateStageScore(index, stage.time, stage.hit), 0);
    
    if (currentEditId) {
      const scoreIndex = allScores.findIndex(s => s.id === currentEditId);
      if (scoreIndex !== -1) {
        allScores[scoreIndex] = {
          ...allScores[scoreIndex],
          name: currentShooterName,
          stages: currentStages,
          totalScore: totalScore,
          date: new Date().toISOString(),
        };
      }
      alert('تم تحديث النتيجة بنجاح!');
    } else {
      const newScore = {
        id: Date.now().toString(),
        name: currentShooterName,
        stages: currentStages,
        totalScore: totalScore,
        date: new Date().toISOString(),
      };
      allScores.push(newScore);
      alert(`تم حفظ نتيجة ${currentShooterName}!`);
    }

    saveScoresToLocalStorage();
    if (currentEditId) {
        window.location.hash = '#results';
    } else {
        resetEntryFormState();
        renderEntryForm();
    }
  }
  
  function handleReset() {
     if (currentEditId) {
      window.location.hash = '#results';
    } else {
      resetEntryFormState();
      renderEntryForm();
    }
  }
  
  function handleDeleteClick(e) {
      const button = e.target.closest('.delete-button');
      const id = button.dataset.id;
      const name = button.dataset.name;
      const confirmationMessage = `هل أنت متأكد من حذف نتيجة الرامي "${name}"؟\n\nلا يمكن التراجع عن هذا الإجراء.`;
      if (window.confirm(confirmationMessage)) {
          allScores = allScores.filter(score => score.id !== id);
          saveScoresToLocalStorage();
          renderResults();
      }
  }
  
  function handleClearAll() {
    if (window.confirm('هل أنت متأكد من رغبتك في حذف جميع النتائج المحفوظة؟ هذا الإجراء لا يمكن التراجع عنه.')) {
        allScores = [];
        saveScoresToLocalStorage();
        renderResults();
    }
  }

  function handleSort(sortBy) {
    currentSortBy = sortBy;
    renderResults();
  }
  
  function handleExportCSV() {
    if (allScores.length === 0) {
      alert('لا توجد نتائج لتصديرها.');
      return;
    }

    const sortedScores = [...allScores].sort((a, b) => {
        if (currentSortBy === 'score') return b.totalScore - a.totalScore;
        return new Date(b.date).getTime() - new Date(a.date).getTime();
    });
    
    const formatDate = (dateString) => new Date(dateString).toLocaleString('ar-EG', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit',
    });

    const headers = ['الرامي', 'التاريخ', 'نقاط م1', 'وقت م1', 'نقاط م2', 'وقت م2', 'نقاط م3', 'وقت م3', 'نقاط م4', 'وقت م4', 'نقاط م5', 'وقت م5', 'النتيجة الإجمالية'];
    
    const rows = sortedScores.map(score => {
      const stageDetails = score.stages.flatMap((stage, index) => {
        const stageScore = calculateStageScore(index, stage.time, stage.hit);
        return [stageScore, stage.time];
      });
      return [`"${score.name.replace(/"/g, '""')}"`, `"${formatDate(score.date)}"`, ...stageDetails, score.totalScore].join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `timing-shooting-results-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }


  // --- HELPERS & STATE LOGIC ---
  const isFormValid = () => currentShooterName.trim() !== '' && currentStages.every(stage => stage.time.trim() !== '' && !isNaN(parseFloat(stage.time)));
  
  function updateSaveButtonState() {
    saveButton.disabled = !isFormValid();
  }
  
  function populateShooterDropdown() {
    shooterNameSelect.innerHTML = '<option value="">-- اختر رامياً --</option>';
    let options = [...shootersList];
    
    // If editing a score for a shooter who was deleted, add them back temporarily
    if (currentEditId && currentShooterName && !options.includes(currentShooterName)) {
        options.push(currentShooterName);
        options.sort((a, b) => a.localeCompare(b, 'ar'));
    }

    options.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        shooterNameSelect.appendChild(option);
    });
    shooterNameSelect.value = currentShooterName;
  }

  function loadFromLocalStorage() {
    try {
      const scoresItem = window.localStorage.getItem(SCORES_STORAGE_KEY);
      allScores = scoresItem ? JSON.parse(scoresItem) : [];
      const shootersItem = window.localStorage.getItem(SHOOTERS_STORAGE_KEY);
      shootersList = shootersItem ? JSON.parse(shootersItem) : [];
    } catch (error) {
      console.error(error);
      allScores = [];
      shootersList = [];
    }
  }

  function saveScoresToLocalStorage() {
    try {
      window.localStorage.setItem(SCORES_STORAGE_KEY, JSON.stringify(allScores));
    } catch (error) {
      console.error(error);
    }
  }

  function saveShootersToLocalStorage() {
    try {
        window.localStorage.setItem(SHOOTERS_STORAGE_KEY, JSON.stringify(shootersList));
    } catch (error) {
        console.error("Failed to save shooters list:", error);
    }
  }
  
  function resetEntryFormState() {
      currentEditId = null;
      currentShooterName = '';
      currentStages = Array(5).fill({ time: '', hit: true });
  }

  // --- NAVIGATION & INITIALIZATION ---
  function navigate() {
    const hash = window.location.hash || '#entry';
    document.getElementById('page-entry').style.display = 'none';
    document.getElementById('page-results').style.display = 'none';

    if (hash.startsWith('#edit/')) {
      const scoreId = hash.split('/')[1];
      const scoreToEdit = allScores.find(s => s.id === scoreId);
      if (scoreToEdit) {
        currentEditId = scoreId;
        currentShooterName = scoreToEdit.name;
        currentStages = scoreToEdit.stages;
        entryTitle.textContent = 'تعديل النتيجة';
        saveButton.textContent = 'حفظ التعديلات';
        resetButton.textContent = 'إلغاء';
      } else {
        alert('النتيجة غير موجودة. ستتم إعادة توجيهك.');
        window.location.hash = '#entry';
        return;
      }
      renderEntryForm();
      document.getElementById('page-entry').style.display = 'block';
    } else if (hash === '#results') {
      renderResults();
      document.getElementById('page-results').style.display = 'block';
    } else { // #entry or default
      if (currentEditId) resetEntryFormState(); // If we came from an edit page, reset
      entryTitle.textContent = 'تسجيل نتائج الرماية';
      saveButton.textContent = 'حفظ النتيجة';
      resetButton.textContent = 'مسح';
      renderEntryForm();
      document.getElementById('page-entry').style.display = 'block';
    }
    updateActiveNav(hash);
  }

  function updateActiveNav(hash) {
      const activeClass = ['bg-sky-600', 'text-white'];
      const defaultClass = ['bg-slate-700', 'hover:bg-slate-600'];
      const navEntry = document.getElementById('nav-entry');
      const navResults = document.getElementById('nav-results');

      navEntry.classList.remove(...activeClass, ...defaultClass);
      navResults.classList.remove(...activeClass, ...defaultClass);

      if (hash.startsWith('#results')) {
          navResults.classList.add(...activeClass);
          navEntry.classList.add(...defaultClass);
      } else {
          navEntry.classList.add(...activeClass);
          navResults.classList.add(...defaultClass);
      }
  }
  
  function init() {
    loadFromLocalStorage();
    navigate();
    
    // Attach permanent event listeners
    window.addEventListener('hashchange', navigate);
    shooterNameSelect.addEventListener('change', handleNameChange);
    saveButton.addEventListener('click', handleSave);
    resetButton.addEventListener('click', handleReset);
    document.getElementById('export-csv-button').addEventListener('click', handleExportCSV);
    document.getElementById('clear-all-button').addEventListener('click', handleClearAll);
    
    stagesContainer.addEventListener('input', (e) => {
        if (e.target.classList.contains('stage-time-input')) {
            handleTimeInputChange(e);
        }
    });
     stagesContainer.addEventListener('click', (e) => {
        if (e.target.closest('.hit-button')) {
            handleHitButtonClick(e);
        }
    });

    // Shooters Modal Listeners
    document.getElementById('manage-shooters-button').addEventListener('click', () => {
        renderShootersListInModal();
        shootersModal.style.display = 'flex';
    });
    document.getElementById('close-modal-button').addEventListener('click', () => {
        shootersModal.style.display = 'none';
    });
    document.getElementById('add-shooter-button').addEventListener('click', handleAddShooter);
    newShooterNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddShooter();
    });
    document.getElementById('import-shooters-button').addEventListener('click', () => {
        shootersFileInput.click();
    });
    shootersFileInput.addEventListener('change', handleImportFile);

  }

  // Start the application
  init();
</script>
</body>
</html>